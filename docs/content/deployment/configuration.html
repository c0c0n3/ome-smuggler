<!DOCTYPE html>
<!--
 * Adapted from: https://github.com/c0c0n3/c0c0n3.github.io/blob/master/index.html
 * (commit: https://github.com/c0c0n3/c0c0n3.github.io/commit/7bc099eb27309ee19b9bff5b8fcd0fc2985f3623) 
-->
<html lang="en">
<head>
  <title>Configuration</title>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link rel="stylesheet" type="text/css" href="http://necolas.github.io/normalize.css/latest/normalize.css" />
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Alegreya" />
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Kaushan+Script" />
  <link rel="stylesheet" type="text/css" href="../../css/style.css" />
  <link rel="stylesheet" type="text/css" href="../../css/zenburn-highlighter.css" />
  
</head>

<body>

<nav>
  <ul>
    <li><em>smuggler</em></li>
    <li><a href="../../content/index.html">home</a></li>
    <li><a href="https://github.com/c0c0n3/ome-smuggler">github</a></li>
    <li><a href="../../content/navigation.svg">site navigation</a></li>
  </ul>
</nav>

<header>
  <section id="header">
    <h1 id="title">Configuration</h1>

    <p id="slogan">season to taste</p>

  </section>
</header>

<main>
  <section id="content">
  <p class="intro">
There are configuration options you can tweak to make Smuggler suit your environment. Even though most of the built-in configuration might work for you out of the box, we suggest you have a quick read through this section.
</p>
<p>Smuggler’s configuration is broken down in groups of configuration items: HTTP, import, mail, and so on, as you can read below. The items of each group go into their own configuration file (e.g. <code>undertow.yml</code> for HTTP) and each file can go in a configurable configuration (recursion madness!) directory or can be embedded directly into Smuggler’s jar file, or both. If a configuration file is both in the configuration directory and inside the jar, then the file in the configuration directory takes precedence: the one inside the jar is ignored. If Smuggler doesn’t find a file in either place, then he’ll use default values for that configuration group.</p>
<div class="pull-quote">
<h6 id="restart-required">Restart Required!</h6>
<p>Every time you change <em>any</em> of your (external) configuration files you’ll have to stop and start the server again for the new configuration to take effect. Ya, I know. It’d be nice to have automatic reload, but I had no time to implement it. Contributions are welcome…</p>
</div>
<p>There are also three sneaky configuration items that determine the directory layout used by Smuggler during its operation. They belong in their own group but there’s no corresponding file for it.</p>
<h2 id="directory-layout">Directory Layout</h2>
<p>Smuggler uses three directories during his operation</p>
<ul>
<li><em>Configuration directory</em>. Where you can put your configuration. Files in here override corresponding jar-embedded files (if any) as explained earlier.</li>
<li><em>Data directory</em>. Where Smuggler keeps each bit of data related to task processing: persistent queues, import and mail recovery data, etc.</li>
<li><em>Log directory</em>. Guess what! Smuggler writes what he’s up to in here: log files.</li>
</ul>
<p>Smuggler doesn’t read or write any data outside of these directories. That’s all he needs. All these directories default to the current working directory of Smuggler’s process, but you can easily change them to something else: set any directory’s path with either a Java property on the command line or use an environment variable. If you specify both, the Java property wins and the value in the environment is ignored. Here are the property and variable names</p>
<ul>
<li><em>Configuration directory</em>. Use <code>ome.smuggler.ConfigDir</code> (Java prop) or <code>SMUGGLER_CONFIGDIR</code> (environment).</li>
<li><em>Data directory</em>. Use <code>ome.smuggler.DataDir</code> (Java prop) or <code>SMUGGLER_DATADIR</code> (environment). If the directory you specify doesn’t exist, it’ll be created.</li>
<li><em>Log directory</em>. Use <code>logging.path</code> (Java prop) or <code>LOG_PATH</code> (environment). (This setting comes from the underlying Spring Boot framework.) If the directory you specify doesn’t exist, it’ll be created.</li>
</ul>
<div class="pull-quote">
<h6 id="security">Security</h6>
<p>Smuggler needs to be able to access all the above directories as well as having read/write permissions for their contents. Besides the sys admin, only the user you run Smuggler with should have access to these directories. In fact, OMERO session keys are kept in the HornetQ queue; also, depending on your set up, the mail configuration may contain an account password.</p>
<p>If the data directory doesn’t exist and you want Smuggler to create it for you, then the Smuggler user must be able to access the parent directory and write to it. Ditto for the log directory. You may be better off creating these directories yourself so that Smuggler doesn’t need to have any rights on the corresponding parent directories.</p>
<p>And as you’re at it, why not secure Smuggler’s jar files as well? Ideally, you’d make them read-only and accessible to the Smuggler user only. You could even go a step further and make them immutable, e.g. using something like <code>chattr +i</code>.</p>
</div>
<h2 id="embedded-configuration">Embedded Configuration</h2>
<p>You can easily embed your configuration into Smuggler’s jar file in two steps. First, edit any of the files in your local Git repo under</p>
<pre><code>    components/server/src/main/resources/config/</code></pre>
<p>For example <code>undertow.yml</code>. Then from the root directory of your local Git repo run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">./gradlew</span> assemble :packager:release</code></pre></div>
<p>(Use <code>gradlew.bat</code> on Windows.) The files you’ve just edited are now embedded into the server jar file contained in each and every distribution bundle generated in</p>
<pre><code>    components/packager/build/distributions/</code></pre>
<p>Pick your bundle and deploy it; you won’t need to add separate configuration files to your deployment (e.g. an external <code>undertow.yml</code>) as the server will read your values from the embedded files. If sometime after deployment you need to tweak your configuration further, you can still add the files you need to your configuration directory and restart the server; these files will take precedence over the ones you’ve embedded, so the configuration the server will use is that of the files you’ve put in the configuration directory.</p>
<h2 id="generating-configuration-files">Generating Configuration Files</h2>
<p>While you can put together your own configuration files from scratch, it may be easier to tweak an existing file. You could pick one from</p>
<pre><code>    components/server/src/main/resources/config/</code></pre>
<p>in your local Git repo. Another option is to generate the file. In fact, all the files in the above directory were generated using commands similar to the below (run from the root of your local Git repo; use <code>gradlew.bat</code> on Windows)</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">./gradlew</span> assemble
$ <span class="kw">java</span> -jar components/server/build/libs/ome-smuggler-*.jar \
       ome.smuggler.run.UndertowYmlGen <span class="kw">&gt;</span> undertow.yml</code></pre></div>
<p>Each configuration group has its own file generation command: a class in the <code>ome.smuggler.run</code> package named after the configuration group and suffixed with <code>Gen</code>—<code>ome.smuggler.run.UndertowYmlGen</code> in the example above. In turn, each of these commands outputs the configuration items read from a corresponding class in <code>ome.smuggler.config.data</code>, e.g. <code>UndertowYmlFile</code>. (All follow the same naming convention, if you’re wondering: group name + <code>File</code>.) So you could actually edit the Java classes in <code>ome.smuggler.config.data</code> to generate your configuration in a more type-safe way. (The compiler should yell at you if you happen to specify rubbish values.)</p>
<h2 id="configuration-groups">Configuration Groups</h2>
<p>Here’s a summary of the various configuration groups. For each of them you’ll find below a short description and the following bullet-point info:</p>
<ul>
<li><em>File</em>. The name of the group’s configuration file.</li>
<li><em>Bean</em>. Fully qualified name of the Java Bean class that holds the group’s items with a link to the corresponding JavaDoc detailing the configuration settings.</li>
<li><em>Defaults</em>. Fully qualified name of the Java class holding the group’s default configuration settings. Look at the code to see how to specify your own settings in a type-safe way, as explained earlier.</li>
<li><em>Command</em>. Fully qualified name of the Java class that generates the group’s configuration file. Use it to output a configuration file when doing the configuration in Java. (The type-safe way, as explained earlier.)</li>
</ul>
<h3 id="http">Http</h3>
<p>Smuggler comes with an embedded Undertow HTTP server. The items in this group specify how to configure it.</p>
<ul>
<li><em>File</em>: <code>undertow.yml</code></li>
<li><em>Bean</em>: <a href="../../../javadoc/server/ome/smuggler/config/items/UndertowConfig.html">ome.smuggler.config.items.UndertowConfig</a></li>
<li><em>Defaults</em>: <code>ome.smuggler.config.data.UndertowYmlFile</code></li>
<li><em>Command</em>: <code>ome.smuggler.run.UndertowYmlGen</code></li>
</ul>
<h3 id="import">Import</h3>
<p>Options to specify how to handle imports, e.g. retries, import logs retention period.</p>
<ul>
<li><em>File</em>: <code>import.yml</code></li>
<li><em>Bean</em>: <a href="../../../javadoc/server/ome/smuggler/config/items/ImportConfig.html">ome.smuggler.config.items.ImportConfig</a></li>
<li><em>Defaults</em>: <code>ome.smuggler.config.data.ImportYmlFile</code></li>
<li><em>Command</em>: <code>ome.smuggler.run.ImportYmlGen</code></li>
</ul>
<h3 id="mail">Mail</h3>
<p>Mail settings such as SMTP or SMTPS agent to use, mail sending account, etc.</p>
<ul>
<li><em>File</em>: <code>mail.yml</code></li>
<li><em>Bean</em>: <a href="../../../javadoc/server/ome/smuggler/config/items/MailConfig.html">ome.smuggler.config.items.MailConfig</a></li>
<li><em>Defaults</em>: <code>ome.smuggler.config.data.MailYmlFile</code></li>
<li><em>Command</em>: <code>ome.smuggler.run.MailYmlGen</code></li>
</ul>
<h3 id="spring">Spring</h3>
<p>Classic Java properties file for Spring and Spring Boot settings. Besides for the app name and log level, we use this file to enable <a href="http://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/html/production-ready.html" title="Spring Boot Actuator Reference">Spring Boot Actuator</a> features.</p>
<ul>
<li><em>File</em>: <code>application.properties</code> (Not easy to follow our naming conventions here as Spring, by default, expects this file name.)</li>
<li><em>Bean</em>: N/A. But properties are set using a tiny type-safe DSL, see the <code>ome.smuggler.config.items.SpringBootConfigProps</code> class.</li>
<li><em>Defaults</em>: <code>ome.smuggler.config.data.SpringBootAppPropsFile</code></li>
<li><em>Command</em>: <code>ome.smuggler.run.SpringBootPropsGen</code></li>
</ul>
<h2 id="other-settings">Other Settings</h2>
<p>There are some other internal configuration settings that are not exposed as they’re mainly useful for development—e.g. using in-memory instead of persistent message queues. If you’re curious, have a look at the classes in the <code>ome.smuggler.config.items</code> package. Also, one thing you’ll need to do if you want to debug the server in your IDE is to specify the location of the <code>ome-cli</code> jar as it defaults to the same directory containing the server jar—see the <code>OmeCliConfig</code> class for the details. To do that, stick an <code>ome-cli.yml</code> file in <code>components/server/</code> (or whichever directory your IDE uses as the current working directory for debugging the server component) with the following content:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">omeCliJarPath:</span> ../cli/build/libs/ome-cli-0.1.0.jar</code></pre></div>
<p>(You may have to adjust the <code>ome-cli</code> version number to match the current one in <code>build.gradle</code>.)</p>
<h2 id="omero-session-timeout">Omero Session Timeout</h2>
<p>Ah, we’ve saved the best until last! Smuggler needs an active session to run an import. The client that requests the import is in charge of creating it and passing it along in the import request. But here’s the issue. OMERO sessions last, by default, at most ten minutes. This would be plenty of time for Smuggler to fetch the import request from his work queue and service it as long as the queue were almost always empty and image files were small. But in practice it can happen that Smuggler’s so busy shovelling tons of data into OMERO that an import request could sit in the queue for more than ten minutes. So when it’s eventually picked up from the queue, its session has already expired and the import will fail. Too bad. But wait a minute! You can easily change the default OMERO session timeout</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">omero</span> config set omero.sessions.timeout 85000000</code></pre></div>
<p>The above tells OMERO to up the session timeout to a bit more than a day. Also note that clients can create a session with a timeout up to ten times longer than the current value of <code>omero.sessions.timeout</code>. (You do this by specifying a time-to-idle to the <code>createUserSession</code> method.)</p>
<div class="pull-quote">
<h6 id="stopgap-solution">Stopgap Solution!</h6>
<p>The plan for the future is to use a session-independent, long-lived token that OMERO would accept to run a specific import. In fact, we’re busy concocting a solution with the friendly OMElings…</p>
</div>
  </section>
</main>  

<footer>
  <section id="footer">
    <p>
      <a href="../../content/index.html">home</a> • 
      <a href="https://github.com/c0c0n3/ome-smuggler">github</a> • 
      <a href="../../content/navigation.svg">site navigation</a>
    </p>
    <p>generated with <a href="https://jaspervdj.be/hakyll/">Hakyll</a> •  
      <a href="https://github.com/c0c0n3/ome-smuggler/tree/gh-pages">source code</a>
    </p> 
    <!-- TODO fonts; legal? -->
  </section>
</footer>
  
</body>
</html>
