<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>FileStreamer.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Smuggler All Tests (Mar 29, 2016 9:20:39 AM)</a> &gt; <a href="../../index.html" class="el_group">ome-smuggler</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">ome.smuggler.web</a> &gt; <span class="el_source">FileStreamer.java</span></div><h1>FileStreamer.java</h1><pre class="source lang-java linenums">package ome.smuggler.web;

import static java.util.Objects.requireNonNull;
import static util.spring.http.ResponseEntities._404;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.function.Consumer;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;

import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;

import ome.smuggler.core.io.FileOps;
import ome.smuggler.core.types.Nat;

/**
 * Streams a file to the HTTP response body or sends a 404 if the file does not
 * exist.
 */
public class FileStreamer {

    private final Path content;
    private final MediaType contentType;
    private final Consumer&lt;HttpServletResponse&gt; cacheStrategy;
    
    /**
     * Creates a new instance to stream the specified file.
     * @param content path to the file to stream.
     * @param contentType the content type to set in the response.
     * @param cacheStrategy sets cache directives in the response.
     * @throws NullPointerException if any argument is {@code null}.
     */
<span class="fc" id="L37">    public FileStreamer(Path content, MediaType contentType, </span>
                        Consumer&lt;HttpServletResponse&gt; cacheStrategy) {
<span class="fc" id="L39">        requireNonNull(content, &quot;content&quot;);</span>
<span class="fc" id="L40">        requireNonNull(contentType, &quot;contentType&quot;);</span>
<span class="fc" id="L41">        requireNonNull(cacheStrategy, &quot;cacheStrategy&quot;);</span>
        
<span class="fc" id="L43">        this.content = content;</span>
<span class="fc" id="L44">        this.contentType = contentType;</span>
<span class="fc" id="L45">        this.cacheStrategy = cacheStrategy;</span>
<span class="fc" id="L46">    }</span>
    
    private void stream(HttpServletResponse response) throws IOException {
<span class="fc" id="L49">        Nat contentSize = FileOps.byteLength(content);  </span>
        
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">        if (contentSize.get() &lt;= Integer.MAX_VALUE) {</span>
<span class="fc" id="L52">            response.setContentLength(contentSize.get().intValue());</span>
        }  // (1)
        
<span class="fc" id="L55">        response.setContentType(contentType.toString());</span>
<span class="fc" id="L56">        cacheStrategy.accept(response);</span>
        
<span class="fc" id="L58">        ServletOutputStream out = response.getOutputStream();</span>
<span class="fc" id="L59">        FileOps.transfer(content, contentSize, out);  // (2)</span>
<span class="fc" id="L60">    }</span>
    /* NOTES.
     * 1. Else can't set; will result in chunked transfer encoding.
     * To see this, use a 200M file without setting the content-length; then the 
     * servlet container splits the content into 16KiB chunks (HEX size = 4000).
     * 2. The file is possibly being written to, so we can't just use Files.copy
     * as it may write more bytes than we declared for the content-length.
     */
    
    /**
     * Streams the file to the client or sends back a 404 if the file does not
     * exist.
     * @param response the response to send to the client.
     * @throws IOException if an I/O error occurs.
     * @throws NullPointerException if the argument is {@code null}.
     */
    public ResponseEntity&lt;String&gt; streamOr404(HttpServletResponse response) 
            throws IOException {
<span class="fc" id="L78">        requireNonNull(response, &quot;response&quot;);</span>
        
<span class="fc bfc" id="L80" title="All 2 branches covered.">        if(Files.exists(content)) {</span>
<span class="fc" id="L81">            stream(response);</span>
<span class="fc" id="L82">            return null;   // (*)</span>
        } else {
<span class="fc" id="L84">            return _404(); // (*)</span>
        }
    }
    /* (*) What? Needed if we want to return a 404.
     * Initially this method returned void and if the file was not found I'd use
     * 
     *  response.sendError(HttpStatus.NOT_FOUND.value(), 
     *                     HttpStatus.NOT_FOUND.getReasonPhrase());
     * 
     * If the file was found, then its content would be streamed as expected,
     * but if the file wasn't there, sendError would have no effect and Spring
     * MVC would override it with a 406 response, possibly caused by the fact
     * a HTTP Converter was selected to handle the response body conversion.
     * So I changed the controller annotation from @RestController to plain
     * @Controller (i.e. no @ResponseBody) and tried to send different accept
     * headers in the request ('* / *', 'text / plain', '* / *, text / plain')
     * but would still get a fat 406! 
     */
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>Smuggler All Tests (Mar 29, 2016 9:20:39 AM)</div></body></html>